#
#		DO NOT EDIT THIS FILE 
#

SHELL = @SHELL@
top_srcdir = @top_srcdir@
srcdir = @srcdir@
VPATH = @srcdir@

@SET_MAKE@
prefix = @prefix@
VERSION = @VERSION@
NUMVER = @NUMVER@
PACKNAME = @PACKNAME@
DISTRIB = @PACKNAME@-@VERSION@
LEAFEXEC = leaf
HUBEXEC = hub
DISTROFILES = config.h.in doc/ misc/ scripts/ ChangeLog Makefile.in build configure pack/ src/
EXCLUDES = pack/pack.cfg misc/ind doc/DEVEL src/Makefile src/compat/Makefile src/mod/Makefile \
           config.cache config.log config.status config.h lush.h stamp.* misc/.cvsignore src/compat/.cvsignore \
           src/mod/dns.mod/.cvsignore src/mod/.cvsignore src/.cvsignore .cvsignore misc/commit misc/fstrings \
           misc/plainh misc/grep misc/cp.sh src/settings.c src/salt.h 

# defaults
CC = @CC@
LD = @CC@
STRIP = @STRIP@

# stuff for Tcl
XREQS = @TCL_REQS@
XLIBS = @TCL_LIBS@ @LIBS@ @ZLIB@ @SSL@
TCLLIB = @TCLLIB@
TCLLIBFN = @TCLLIBFN@

modconf = $(top_srcdir)/misc/modconfig --top_srcdir=$(top_srcdir)

DEBCFLAGS = -DDEBUG_ASSERT -DDEBUG_MEM -g3 -ggdb3
CFLGS = -fno-strict-aliasing
MAKEFLAGS = -s -j4

MAKE_LEAF = $(MAKE) 'MAKE=$(MAKE)' 'CC=$(CC)' 'LD=$(LD)' \
'STRIP=$(STRIP)' 'CFLGS=$(CFLGS) -DLEAF' \
'TCLLIB=$(TCLLIB)' 'TCLLIBFN=$(TCLLIBFN)' 'XREQS=$(XREQS)' \
'XLIBS=$(XLIBS)' 'EGGEXEC=$(LEAFEXEC)' 'EGGBUILD=(leaf)' \
'MODOBJS=mod/*.o' 

MAKE_DLEAF = $(MAKE) 'MAKE=$(MAKE)' 'CC=$(CC)' 'LD=$(LD) -g' \
'STRIP=touch' 'CFLGS=$(DEBCFLAGS) -DLEAF $(CFLGS)' \
'TCLLIB=$(TCLLIB)' 'TCLLIBFN=$(TCLLIBFN)' 'XREQS=$(XREQS)' 'XLIBS=$(XLIBS)' \
'EGGEXEC=$(LEAFEXEC)' 'EGGBUILD=(debug leaf)' 'MODOBJS=mod/*.o'

MAKE_HUB = $(MAKE) 'MAKE=$(MAKE)' 'CC=$(CC)' 'LD=$(LD)' \
'STRIP=$(STRIP)' 'CFLGS=$(CFLGS) -DHUB' \
'TCLLIB=$(TCLLIB)' 'TCLLIBFN=$(TCLLIBFN)' 'XREQS=$(XREQS)' \
'XLIBS=$(XLIBS)' 'EGGEXEC=$(HUBEXEC)' 'EGGBUILD=(hub)' \
'MODOBJS=mod/*.o'

MAKE_DHUB = $(MAKE) 'MAKE=$(MAKE)' 'CC=$(CC)' 'LD=$(LD) -g' \
'STRIP=touch' 'CFLGS=$(DEBCFLAGS) -DHUB $(CFLGS)' \
'TCLLIB=$(TCLLIB)' 'TCLLIBFN=$(TCLLIBFN)' 'XREQS=$(XREQS)' 'XLIBS=$(XLIBS)' \
'EGGEXEC=$(HUBEXEC)' 'EGGBUILD=(debug hub)' 'MODOBJS=mod/*.o'

MAKE_UTILS = $(MAKE) 'MAKE=$(MAKE)' 'CC=$(CC)' 'STRIP=touch' \
'CFLGS=$(DEBCFLAGS) $(CFLGS)' 'XREQS=$(XREQS)' 'XLIBS=$(XLIBS)' 'LD=$(LD) -g'

MAKE_UTILS_NR = $(MAKE) 'CC=$(CC)' 'STRIP=touch' \
'CFLGS=$(DEBCFLAGS) $(CFLGS)' 'XREQS=$(XREQS)' 'XLIBS=$(XLIBS)' 'LD=$(LD) -g'

MAKE_CONFIG = $(MAKE) 'MAKE=$(MAKE)'

all:
	@echo ""
	@echo "Use the build script."
	@echo ""

cleanutils:
	@rm -f src/stringfix src/makesettings src/sorthelp src/makehelp
	@misc/dostrings l

clean:  cleanutils
	+@cd src && $(MAKE) clean
	+@cd src/compat && $(MAKE) clean
	+@cd src/mod && $(MAKE) distclean
	@rm -f $(HUBEXEC) $(LEAFEXEC) *.stamp core DEBUG *~ src/*~ key configure.temp .mangled
	@rm -f $(HUBEXEC).* $(LEAFEXEC).* src/settings.c src/salt.h src/help.h utctime

distclean: clean clean-modconfig
	@rm -f Makefile src/Makefile src/compat/Makefile src/mod/Makefile
	@rm -f config.cache config.log config.status config.h lush.h stamp.*
	@rm -rf *-$(VERSION)/ autom4te.cache/ autoscan.log configure.scan src/salt.h.tmp src/conf.h


distrib: clean clean-modconfig
	@rm -rf $(DISTRIB)/
	@mkdir $(DISTRIB) && cp -r $(DISTROFILES) $(DISTRIB)
	@rm -f `find $(DISTRIB)/ \( -name '*~' -o -name '*#' -o -name '*.orig' -o -name '*.rej' -o -name '*.bak' \) -print`
	@rm -rf `find $(DISTRIB)/ \( -name 'CVS' \) -print`
	@for s in $(EXCLUDES); \
	do \
	 rm -rf $(DISTRIB)/$$s; \
	done;
	@mfiles="`find $(DISTRIB)/src/ -name '*.h' -or -name '*.c'`"; \
	for s in $$mfiles; \
	do \
	 mangle -rnw $$s > /dev/null 2>&1;\
	done

tar: distrib
	tar -czvf $(DISTRIB).tgz $(DISTRIB)/
	ls -al $(DISTRIB).tgz
#	rm -rf $(DISTRIB)/
#	cd ../ && rm -rf distrib/

eggautoconf:
	@$(modconf) eggautoconf

packconf: makesettings pack/pack.cfg
	@src/makesettings pack/pack.cfg src/settings.c~
	@(if [ ! -f src/settings.c ]; then \
	touch src/settings.c; \
	fi)
	@(if test "x`diff -qurN src/settings.c~ src/settings.c`" != "x"; then \
	cp -f src/settings.c~ src/settings.c; \
	fi)
	@(if [ ! -f src/conf.h ]; then \
	touch src/conf.h; \
	fi)
	@(if test "x`diff -qurN src/conf.h~ src/conf.h`" != "x"; then \
	cp -f src/conf.h~ src/conf.h; \
	fi)

salt: packconf stringfix
	@(if [ ! -f src/salt.h ]; then \
	touch src/salt.h; \
	fi)
	@src/stringfix src/salt.h.tmp src/salt.h~
	@(if test "x`diff -qurN src/salt.h~ src/salt.h`" != "x"; then \
	echo -n "[*] Encrypting salts..."; \
	src/stringfix src/salt.h.tmp src/salt.h; \
	echo "done."; \
	fi)

sort: sorthelp
	@cp -f misc/help.txt misc/help.bak
	@(if test "x`tail -n 1 misc/help.txt`" != "x::end"; then \
	echo "::end" >> misc/help.txt; \
	fi)
#	@(sed misc/help.txt -e "s/^$$/ /" > help~ && mv -f help~ misc/help.txt) || rm -f help~
	@(sed -r -e :a -e 's/^$$/ /' -e '$$!N;s/^ \n:/:/;ta' -e 'P;D' misc/help.txt > help~ && mv -f help~ misc/help.txt) || rm -f help~
	@cp -f misc/help.txt help.txt~
	@(src/sorthelp misc/help.txt misc/help.txt || (cp -f help.txt~ misc/help.txt; echo "Sort failed, restoring backup."))
	@rm -f help.txt~

help: packconf makehelp stringfix
	@src/makehelp misc/help.txt src/help.h.tmp~
	@(if [ ! -f src/help.h ]; then \
	touch src/help.h; \
	fi)
	@src/stringfix src/help.h.tmp~ src/help.h~ 1
	@(if test "x`diff -qurN src/help.h~ src/help.h`" != "x"; then \
	cp -f src/help.h~ src/help.h; \
	fi)

config:
	@$(modconf) modules-still-exist
	@$(modconf) detect-modules
	@$(modconf) update-depends
	@$(modconf) Makefile
	+@cd src/mod && $(MAKE_CONFIG) config
	@$(modconf) Makefile

clean-modconfig:
	@rm -f .modules .known_modules

reconfig: clean-modconfig config


stringfix: packconf src/stringfix.c pack/pack.cfg
	+@cd src && ${MAKE_UTILS} stringfix

makesettings: src/makesettings.c
	+@cd src && ${MAKE_UTILS} makesettings

makehelp: packconf src/makehelp.c
	+@cd src && ${MAKE_UTILS} makehelp

sorthelp: src/sorthelp.c
	+@cd src && ${MAKE_UTILS} sorthelp

utils: makesettings stringfix makehelp

dostrings: stringfix
	@misc/dostrings

general: makesettings packconf salt help dostrings config

leaf:	general
	@echo ""
	@echo "Making leaf"
	@echo ""
	@rm -f src/mod/mod.xlibs
	@./misc/maketype leaf
	@echo ""
	+@cd src/mod && $(MAKE_LEAF) static
	@echo ""
	+@cd src && $(MAKE_LEAF) $(LEAFEXEC)
	@echo ""

dleaf:  general
	@echo ""
	@echo "Making debug leaf"
	@echo ""
	@rm -f src/mod/mod.xlibs
	@./misc/maketype leaf
	@echo ""
	+@cd src/mod && $(MAKE_DLEAF) static
	@echo ""
	+@cd src && $(MAKE_DLEAF) $(LEAFEXEC)
	@echo ""

hub:	general
	@echo ""
	@echo "Making hub"
	@echo ""
	@rm -f src/mod/mod.xlibs
	@rm -f src/mod/mod.xlibs
	@./misc/maketype hub
	@echo ""
	+@cd src/mod && $(MAKE_HUB) static
	@echo ""
	+@cd src && $(MAKE_HUB) $(HUBEXEC)
	@echo ""

dhub:   general
	@echo ""
	@echo "Making debug hub"
	@echo ""
	@rm -f src/mod/mod.xlibs
	@./misc/maketype hub
	@echo ""
	+@cd src/mod && $(MAKE_DHUB) static
	@echo ""
	+@cd src && $(MAKE_DHUB) $(HUBEXEC)
	@echo ""

#safety hash

